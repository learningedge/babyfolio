<% is_edit_moment = false if is_edit_moment.blank?   -%>
<div class="uploaded-images-container <%= "is-edit-moment" if is_edit_moment -%>">
    
    <div class="main-header">
      <% unless is_edit_moment %>
        <h2>Uploaded Photos</h2>
        <a href="#" class="upload-link">Upload image</a>
        <a href="#" class="close-btn">Close</a>
        <div class="clear"></div>
      <% else %>
        <div>Choose file from your computer.</div>
      <% end %>
    </div>
    <div id="file-uploader" <%= "class='hidden'" unless is_edit_moment -%>></div>
    <div class="clear"></div>
  
  <div class="uploaded-images">

    <span id="selected-uploaded-images-photos">
      <h2>Selected</h2>
    </span>
    <% unless is_edit_moment %>
      <span id="uploaded-images-ajax-grid"  class="uploaded-images-grid">

        <% images = Media.where(:user_id => current_user.id, :type => 'MediaImage') -%>


        <%= render :partial => 'uploaded_images/uploaded_images', :locals => { :images => images } %>

      </span>
    <% end %>

    <div class="clear"></div>

  </div>
  
</div>

<script type="text/javascript">
  $(function() {
    var global_count = -1;
    var uploader = new qq.FileUploader({
        element: document.getElementById('file-uploader'),
        action: '<%= upload_image_path %>',
        onComplete: function(id, fileName, responseJSON){
          $('.qq-upload-file').each(function(){if ( $(this).text() == fileName) {$(this).parents('li').fadeOut(2000);} });
          $.ajax({
            url: '<%= upload_image_index_url -%>'+'?id='+responseJSON.media_id,
            success: function(data){
              var data_value = $(data);              
              <% unless is_edit_moment %>
                $('#uploaded-images-ajax-grid .photos').append(data_value);
                data_value.animate({opacity:1});
              <% else %>
                var element = $(data_value).append('<input type="hidden" name="uploaded_images_pids[]" value="'+$(data_value).attr('id')+'"/>')                
                element.appendTo('#selected-media .selected-container');
              <% end %>
            }
          })          
        },        
        onCancel: function(id,fileName){
          global_count = global_count + 1;
        }
    });

    //multiselect functionality
    $('.multiselect .uploaded-images .uploaded-images-grid .photos .image').live("click",function(){
      if($('#selected-uploaded-images-photos #'+$(this).attr('id')).length == 0) {
        element = $('<span class="selected-image" id="'+$(this).attr('id')+'" style="background-image: url('+ $(this).attr('thumb_url') +')"><input type="hidden" name="uploaded_images_pids[]" value="'+$(this).attr('id')+'"/><div class="hover">Remove</div></span>')
        element.appendTo('#selected-uploaded-images-photos');
      }
      if(typeof addSelectedImage == 'function'){
        addSelectedImage($(this));
      }      
    });

    //singleselect functionality
    $('.singleselect .uploaded-images .uploaded-images-grid .photos .image').live("click",function(){
      $('#selected-uploaded-images-photos .selected-image').remove();
      element = $('<span class="selected-image" id="'+$(this).attr('id')+'" style="background-image: url('+ $(this).attr('thumb_url') +')"><input type="hidden" name="uploaded_images_pids[]" value="'+$(this).attr('id')+'"/><div class="hover">Remove</div></span>')
      element.appendTo('#selected-uploaded-images-photos');
    })

    //selected images functionality
    $('.uploaded-images #selected-uploaded-images-photos .selected-image').live({
        mouseover: function(){
            $(this).find('.hover').show().css({opacity:0.5});
        },
        mouseleave: function(){
            $(this).find('.hover').hide();
        }
    })
    $('.uploaded-images #selected-uploaded-images-photos .selected-image').live('click',function(){
        $(this).remove();        
    })

    //upload images

    $('.main-header a.upload-link').click(function(){

      $(this).parents('.uploaded-images-container').find('#file-uploader').css({height: 0}).show().animate({height: 100});
      $(this).hide();
      $(this).parents('.uploaded-images-container').find('.main-header .close-btn').show();
      return false;

    })

    $('.uploaded-images-container .main-header .close-btn').click(function(){
        $(this).parents('.uploaded-images-container').find('#file-uploader').stop().animate({height: 0}, function(){$(this).hide(); })
        $(this).hide();
        $(this).parents('.uploaded-images-container').find('.main-header .upload-link').show();
        return false;
    })

  });
</script>
